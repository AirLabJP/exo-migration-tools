# 本番環境 構築・設定 コマンドリスト

本ファイルは「本番環境_構築設定手順書.docx」と紐づくコマンドリストです。
項番に対応するコマンドをコピペして実行してください。

---

## 事前準備: 接続

### PowerShellモジュールインストール（初回のみ）
```powershell
# Exchange Online
Install-Module ExchangeOnlineManagement -Scope CurrentUser

# Microsoft Graph
Install-Module Microsoft.Graph -Scope CurrentUser
```

### Exchange Online接続
```powershell
Connect-ExchangeOnline -UserPrincipalName admin@contoso.onmicrosoft.com
```

### Microsoft Graph接続（読み取り用）
```powershell
Connect-MgGraph -Scopes "User.Read.All","Group.Read.All"
```

### Microsoft Graph接続（書き込み用）
```powershell
Connect-MgGraph -Scopes "User.ReadWrite.All","Group.ReadWrite.All","Directory.ReadWrite.All"
```

---

## 3. Phase 1: 事前準備・棚卸し

### 3.1.1 前提条件チェック（全体）
```powershell
.\execution\phase1-preparation\Test-Prerequisites.ps1 -All
```

### 3.1.2 前提条件チェック（AD のみ）
```powershell
.\execution\phase1-preparation\Test-Prerequisites.ps1 -CheckAD
```

### 3.1.3 前提条件チェック（EXO/Graph のみ）
```powershell
.\execution\phase1-preparation\Test-Prerequisites.ps1 -CheckEXO -CheckGraph
```

### 3.2.1 AD棚卸し
```powershell
.\inventory\Collect-ADInventory.ps1 -OutRoot C:\EXO-Migration\Output\inventory
```

### 3.2.2 Entra ID棚卸し
```powershell
.\inventory\Collect-EntraInventory.ps1 -OutRoot C:\EXO-Migration\Output\inventory
```

### 3.2.3 EXO棚卸し
```powershell
.\inventory\Collect-EXOInventory.ps1 -OutRoot C:\EXO-Migration\Output\inventory
```

### 3.2.4 DNS棚卸し
```powershell
.\inventory\Collect-DNSRecords.ps1 -DomainsFile domains.txt -OutRoot C:\EXO-Migration\Output\inventory
```

### 3.2.5 Postfix設定収集（Linux: Postfixサーバーで実行）
```bash
sudo bash inventory/collect_postfix.sh /tmp/inventory
```

### 3.2.6 Courier IMAP設定収集（Linux: IMAPサーバーで実行）
```bash
sudo bash inventory/collect_courier_imap.sh /tmp/inventory
```

### 3.2.7 DMZ SMTP設定収集（Linux: DMZ SMTPサーバーで実行）
```bash
sudo bash inventory/collect_smtp_dmz.sh /tmp/inventory
```

### 3.3.1 紛れ受信者検出
```powershell
.\analysis\Detect-StrayRecipients.ps1 `
    -ExoRecipientsCsv C:\EXO-Migration\Output\inventory\exo_*\recipients.csv `
    -AdUsersCsv C:\EXO-Migration\Output\inventory\ad_*\ad_users_mailattrs.csv `
    -TargetDomainsFile domains.txt
```

### 3.3.2 紛れ対処計画作成
```powershell
.\analysis\Plan-RecipientRemediation.ps1 `
    -StrayReportPath C:\EXO-Migration\Output\stray_report\*\strays_action_required.csv `
    -AutoClassify
```

### 3.3.3 紛れ対処実行（WhatIfモード）
```powershell
.\analysis\Invoke-RecipientRemediation.ps1 `
    -RemediationPlanPath C:\EXO-Migration\Output\remediation_plan\*\remediation_plan.csv `
    -WhatIfMode
```

### 3.3.4 紛れ対処実行（本番）
```powershell
.\analysis\Invoke-RecipientRemediation.ps1 `
    -RemediationPlanPath C:\EXO-Migration\Output\remediation_plan\*\remediation_plan.csv
```

### 3.4.1 ADスキーマ拡張
```powershell
.\execution\phase1-preparation\Invoke-ExchangeSchemaPrep.ps1 `
    -SetupExePath D:\ExchangeSetup\Setup.exe `
    -OrganizationName "Contoso"
```

### 3.5.1 EXO設定スナップショット（変更前）
```powershell
.\inventory\Export-EXOConfigSnapshot.ps1 -SnapshotName "before_migration"
```

---

## 4. Phase 2: EXO箱作り

### 4.1.1 SMTP重複チェック
```powershell
.\analysis\Test-SmtpDuplicates.ps1 `
    -CsvPath mail_addresses.csv `
    -AdUsersCsv C:\EXO-Migration\Output\inventory\ad_*\ad_users_mailattrs.csv
```

### 4.2.1 ADメール属性投入（WhatIfモード）
```powershell
.\execution\phase2-setup\Set-ADMailAddressesFromCsv.ps1 `
    -CsvPath mail_addresses.csv `
    -WhatIfMode
```

### 4.2.2 ADメール属性投入（本番）
```powershell
.\execution\phase2-setup\Set-ADMailAddressesFromCsv.ps1 `
    -CsvPath mail_addresses.csv
```

### 4.3.1 EXOコネクタ作成（WhatIfモード）
```powershell
.\execution\phase2-setup\New-EXOConnectors.ps1 `
    -OnPremDmzSmtpHost "dmz-smtp.internal.example.co.jp" `
    -AwsDmzSmtpIP "203.0.113.10" `
    -TargetDomainsFile domains.txt `
    -WhatIfMode
```

### 4.3.2 EXOコネクタ作成（本番）
```powershell
.\execution\phase2-setup\New-EXOConnectors.ps1 `
    -OnPremDmzSmtpHost "dmz-smtp.internal.example.co.jp" `
    -AwsDmzSmtpIP "203.0.113.10" `
    -TargetDomainsFile domains.txt
```

### 4.3.3 EXOコネクタ作成（送信セキュリティあり）
```powershell
.\execution\phase2-setup\New-EXOConnectors.ps1 `
    -MailSecurityHost "mailsecurity.example.com" `
    -OnPremDmzSmtpHost "dmz-smtp.internal.example.co.jp" `
    -AwsDmzSmtpIP "203.0.113.10" `
    -TargetDomainsFile domains.txt
```

### 4.4.1 Transport Rule作成（WhatIfモード）
```powershell
.\execution\phase2-setup\New-EXOTransportRules.ps1 `
    -TargetDomainsFile domains.txt `
    -WhatIfMode
```

### 4.4.2 Transport Rule作成（本番）
```powershell
.\execution\phase2-setup\New-EXOTransportRules.ps1 `
    -TargetDomainsFile domains.txt
```

### 4.5.1 ライセンスグループ追加（WhatIfモード）
```powershell
.\execution\phase2-setup\Add-UsersToLicenseGroup.ps1 `
    -CsvPath migration_users.csv `
    -GroupName "EXO-License-Pilot" `
    -WhatIfMode
```

### 4.5.2 ライセンスグループ追加（本番）
```powershell
.\execution\phase2-setup\Add-UsersToLicenseGroup.ps1 `
    -CsvPath migration_users.csv `
    -GroupName "EXO-License-Pilot"
```

### 4.5.3 ライセンスグループからユーザー削除
```powershell
.\execution\phase2-setup\Add-UsersToLicenseGroup.ps1 `
    -CsvPath migration_users.csv `
    -GroupName "EXO-License-Pilot" `
    -RemoveMode
```

---

## 5. Phase 3: ルーティング変更

### 5.1.1 テストメールボックス作成（WhatIfモード）
```powershell
.\execution\phase3-routing\New-TestMailboxes.ps1 `
    -TestDomain "test.contoso.co.jp" `
    -Count 3 `
    -WhatIfMode
```

### 5.1.2 テストメールボックス作成（本番）
```powershell
.\execution\phase3-routing\New-TestMailboxes.ps1 `
    -TestDomain "test.contoso.co.jp" `
    -Count 3
```

### 5.2.1 Accepted Domain変更（WhatIfモード）
```powershell
.\execution\phase3-routing\Set-AcceptedDomainType.ps1 `
    -DomainsFile domains.txt `
    -DomainType InternalRelay `
    -WhatIfMode
```

### 5.2.2 Accepted Domain変更（本番）
```powershell
.\execution\phase3-routing\Set-AcceptedDomainType.ps1 `
    -DomainsFile domains.txt `
    -DomainType InternalRelay
```

### 5.3.1 DMZ SMTPルーティング変更（ドライラン）（Linux: AWS DMZ SMTPで実行）
```bash
sudo bash execution/phase3-routing/Set-DmzSmtpRouting.sh \
    -d domains.txt \
    -m tenant.mail.protection.outlook.com \
    -n
```

### 5.3.2 DMZ SMTPルーティング変更（本番）（Linux: AWS DMZ SMTPで実行）
```bash
sudo bash execution/phase3-routing/Set-DmzSmtpRouting.sh \
    -d domains.txt \
    -m tenant.mail.protection.outlook.com
```

### 5.3.3 Postfixルーティング変更（オプション）（Linux: 内部Postfixで実行）
```bash
sudo bash execution/phase3-routing/Set-PostfixRouting.sh \
    -d domains.txt \
    -m tenant.mail.protection.outlook.com
```

---

## 6. Phase 4: 検証

### 6.1.1 テストメール送信
```powershell
.\lab-env\Send-TestEmail.ps1 -To "user@example.co.jp" -Subject "移行テスト"
```

### 6.1.2 メールフローマトリクス検証
```powershell
.\execution\phase4-validation\Test-MailFlowMatrix.ps1 `
    -TestCasesFile test_cases.csv `
    -LookbackHours 24
```

### 6.3.1 EXO設定スナップショット（変更後）
```powershell
.\inventory\Export-EXOConfigSnapshot.ps1 -SnapshotName "after_migration"
```

---

## 7. 切り戻し手順

### 7.1.1 DMZ SMTPルーティング復元（Linux: AWS DMZ SMTPで実行）
```bash
sudo bash execution/rollback/Restore-DmzSmtpRouting.sh --latest
```

### 7.1.2 Postfixルーティング復元（Linux: 内部Postfixで実行）
```bash
sudo bash execution/rollback/Restore-PostfixRouting.sh --latest
```

### 7.1.3 Accepted Domain復元
```powershell
.\execution\rollback\Restore-AcceptedDomainType.ps1 `
    -DomainsFile domains.txt
```

### 7.2.1 EXOコネクタ削除
```powershell
.\execution\rollback\Undo-EXOConnectors.ps1
```

---

## 確認用コマンド

### EXO設定確認

#### Accepted Domain一覧
```powershell
Get-AcceptedDomain | Format-Table Name, DomainType, Default
```

#### Inboundコネクタ一覧
```powershell
Get-InboundConnector | Format-Table Name, Enabled, ConnectorType
```

#### Outboundコネクタ一覧
```powershell
Get-OutboundConnector | Format-Table Name, Enabled, UseMXRecord, SmartHosts
```

#### Transport Rule一覧
```powershell
Get-TransportRule | Format-Table Name, State, Priority
```

#### メールボックス一覧
```powershell
Get-Mailbox | Format-Table DisplayName, PrimarySmtpAddress, RecipientTypeDetails
```

#### Message Trace（過去24時間）
```powershell
Get-MessageTrace -StartDate (Get-Date).AddHours(-24) -EndDate (Get-Date) | Format-Table Received, SenderAddress, RecipientAddress, Status
```

### AD設定確認

#### ユーザーのメール属性確認
```powershell
Get-ADUser -Identity "username" -Properties mail, proxyAddresses | Select-Object Name, mail, proxyAddresses
```

#### スキーマバージョン確認
```powershell
Get-ADObject "CN=ms-Exch-Schema-Version-Pt,CN=Schema,CN=Configuration,DC=contoso,DC=local" -Properties rangeUpper | Select-Object rangeUpper
```

### Entra ID設定確認

#### 同期ステータス確認
```powershell
Get-ADSyncScheduler
```

#### 手動同期（差分）
```powershell
Start-ADSyncSyncCycle -PolicyType Delta
```

#### 手動同期（フル）
```powershell
Start-ADSyncSyncCycle -PolicyType Initial
```

### Linux設定確認（SSH接続後）

#### Postfix transport確認
```bash
cat /etc/postfix/transport
postmap -q "example.co.jp" /etc/postfix/transport
```

#### Postfixログ確認
```bash
tail -100 /var/log/mail.log
```

#### メールキュー確認
```bash
mailq
```

#### Postfix設定確認
```bash
postconf -n
```

---

## 切断コマンド

### Exchange Online切断
```powershell
Disconnect-ExchangeOnline -Confirm:$false
```

### Microsoft Graph切断
```powershell
Disconnect-MgGraph
```

---

## クリーンアップ

### Windows: 出力ファイル削除
```powershell
Remove-Item -Recurse -Force C:\EXO-Migration\Output\inventory*
Remove-Item -Recurse -Force .\inventory_*
Remove-Item -Recurse -Force .\stray_report
Remove-Item -Recurse -Force .\duplicate_check
Remove-Item -Recurse -Force .\prereq_check
Remove-Item -Recurse -Force .\accepted_domain_change
Remove-Item -Recurse -Force .\mailflow_validation
Remove-Item -Recurse -Force .\connector_rollback
```

### Linux: 出力ファイル削除
```bash
rm -rf /tmp/inventory*
rm -rf ./inventory_*
```
