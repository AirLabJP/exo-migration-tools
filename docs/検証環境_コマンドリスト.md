# 検証環境 構築・設定 コマンドリスト

本ファイルは「検証環境_構築設定手順書.docx」と紐づくコマンドリストです。
項番に対応するコマンドをコピペして実行してください。

---

## 5. Hyper-V環境構築

### 5.1.1 Hyper-Vの有効化
```powershell
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All
```

### 5.2.1 内部ネットワーク用スイッチ作成
```powershell
New-VMSwitch -Name "EXO-Lab-Internal" -SwitchType Internal
```

### 5.2.2 外部接続用スイッチ作成
```powershell
# ※ネットワークアダプタ名は環境に合わせて変更
New-VMSwitch -Name "EXO-Lab-External" -NetAdapterName "イーサネット" -AllowManagementOS $true
```

### 5.3.1 DC01 VM作成
```powershell
$VMName = "DC01"
$VMPath = "D:\Hyper-V\$VMName"

New-VM -Name $VMName -MemoryStartupBytes 4GB -Generation 2 -Path $VMPath
Set-VMMemory -VMName $VMName -DynamicMemoryEnabled $true -MinimumBytes 2GB -MaximumBytes 8GB
Set-VMProcessor -VMName $VMName -Count 2
New-VHD -Path "$VMPath\$VMName.vhdx" -SizeBytes 100GB -Dynamic
Add-VMHardDiskDrive -VMName $VMName -Path "$VMPath\$VMName.vhdx"
Connect-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-Internal"
Add-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-External"
Set-VMDvdDrive -VMName $VMName -Path "D:\ISO\WindowsServer2022.iso"
```

### 5.3.2 DC02 VM作成
```powershell
$VMName = "DC02"
$VMPath = "D:\Hyper-V\$VMName"

New-VM -Name $VMName -MemoryStartupBytes 4GB -Generation 2 -Path $VMPath
Set-VMMemory -VMName $VMName -DynamicMemoryEnabled $true -MinimumBytes 2GB -MaximumBytes 8GB
Set-VMProcessor -VMName $VMName -Count 2
New-VHD -Path "$VMPath\$VMName.vhdx" -SizeBytes 100GB -Dynamic
Add-VMHardDiskDrive -VMName $VMName -Path "$VMPath\$VMName.vhdx"
Connect-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-Internal"
Add-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-External"
Set-VMDvdDrive -VMName $VMName -Path "D:\ISO\WindowsServer2022.iso"
```

### 5.3.3 AADC01 VM作成
```powershell
$VMName = "AADC01"
$VMPath = "D:\Hyper-V\$VMName"

New-VM -Name $VMName -MemoryStartupBytes 4GB -Generation 2 -Path $VMPath
Set-VMMemory -VMName $VMName -DynamicMemoryEnabled $true -MinimumBytes 2GB -MaximumBytes 8GB
Set-VMProcessor -VMName $VMName -Count 2
New-VHD -Path "$VMPath\$VMName.vhdx" -SizeBytes 100GB -Dynamic
Add-VMHardDiskDrive -VMName $VMName -Path "$VMPath\$VMName.vhdx"
Connect-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-Internal"
Add-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-External"
Set-VMDvdDrive -VMName $VMName -Path "D:\ISO\WindowsServer2022.iso"
```

---

## 6. Active Directory構築

### 6.1.1 AD DS役割インストール（DC01）
```powershell
Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools
```

### 6.1.2 フォレスト・ドメイン作成（DC01）
```powershell
$DomainName = "lab.local"
$NetBIOSName = "LAB"
$SafeModePassword = ConvertTo-SecureString "P@ssw0rd123!" -AsPlainText -Force

Install-ADDSForest `
    -DomainName $DomainName `
    -DomainNetBIOSName $NetBIOSName `
    -SafeModeAdministratorPassword $SafeModePassword `
    -InstallDns:$true `
    -Force:$true
```

### 6.2.1 ドメイン参加（DC02）
```powershell
$DomainName = "lab.local"
$Credential = Get-Credential  # LAB\Administrator
Add-Computer -DomainName $DomainName -Credential $Credential -Restart
```

### 6.2.2 レプリカDCに昇格（DC02）
```powershell
Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools

$SafeModePassword = ConvertTo-SecureString "P@ssw0rd123!" -AsPlainText -Force
$Credential = Get-Credential  # LAB\Administrator

Install-ADDSDomainController `
    -DomainName "lab.local" `
    -Credential $Credential `
    -SafeModeAdministratorPassword $SafeModePassword `
    -InstallDns:$true `
    -Force:$true
```

### 6.3.1 ADスキーマ拡張（DC01 - スキーママスター）
```powershell
# Exchange Server ISO を D: にマウント後に実行
D:\Setup.exe /PrepareSchema /IAcceptExchangeServerLicenseTerms_DiagnosticDataON
D:\Setup.exe /PrepareAD /OrganizationName:"LabOrg" /IAcceptExchangeServerLicenseTerms_DiagnosticDataON
D:\Setup.exe /PrepareDomain /IAcceptExchangeServerLicenseTerms_DiagnosticDataON
```

### 6.4 レプリケーション確認
```powershell
repadmin /replsummary
```

---

## 7. Docker環境構築

### 7.2.1 プロジェクトディレクトリへ移動
```bash
cd exo-migration-tools/lab-env/docker
```

### 7.2.2 コンテナ起動
```bash
docker-compose up -d --build
docker-compose ps
```

### 7.3 コンテナログ確認
```bash
docker-compose logs courier-imap
docker-compose logs postfix-hub
docker-compose logs dmz-aws
docker-compose logs dmz-internal
```

---

## 8. Entra ID Connect設定

### 8.1.1 ドメイン参加（AADC01）
```powershell
$DomainName = "lab.local"
$Credential = Get-Credential  # LAB\Administrator
Add-Computer -DomainName $DomainName -Credential $Credential -Restart
```

### 8.3 同期状態確認
```powershell
# 同期ステータス確認
Get-ADSyncScheduler

# 手動同期実行（差分）
Start-ADSyncSyncCycle -PolicyType Delta

# 手動同期実行（フル）
Start-ADSyncSyncCycle -PolicyType Initial
```

---

## 9. Exchange Online設定

### 9.1 EXO接続
```powershell
# モジュールインストール（初回のみ）
Install-Module ExchangeOnlineManagement -Scope CurrentUser

# 接続
Connect-ExchangeOnline -UserPrincipalName admin@contoso.onmicrosoft.com
```

### 9.2.1 テストユーザー作成（ADパターン）
```powershell
.\execution\phase2-setup\New-ADUsersFromCsv.ps1 `
    -CsvPath templates\sample_users_ad.csv `
    -TargetOU "OU=TestUsers,DC=lab,DC=local" `
    -SetMailAttributes
```

### 9.2.2 テストユーザー作成（Entra IDパターン）
```powershell
.\execution\phase2-setup\New-EntraUsersFromCsv.ps1 `
    -CsvPath templates\sample_users_entra.csv `
    -LicenseGroupName "EXO-License-Pilot"
```

### 9.3.1 コネクタ作成（WhatIfモード）
```powershell
.\execution\phase2-setup\New-EXOConnectors.ps1 `
    -OnPremDmzSmtpHost "dmz-smtp.internal.example.co.jp" `
    -AwsDmzSmtpIP "203.0.113.10" `
    -TargetDomainsFile domains.txt `
    -WhatIfMode
```

### 9.3.2 コネクタ作成（本番実行）
```powershell
.\execution\phase2-setup\New-EXOConnectors.ps1 `
    -OnPremDmzSmtpHost "dmz-smtp.internal.example.co.jp" `
    -AwsDmzSmtpIP "203.0.113.10" `
    -TargetDomainsFile domains.txt
```

---

## 10. メールフロー設定

### 10.1.1 Transport Rule作成（WhatIfモード）
```powershell
.\execution\phase2-setup\New-EXOTransportRules.ps1 `
    -TargetDomainsFile domains.txt `
    -WhatIfMode
```

### 10.1.2 Transport Rule作成（本番実行）
```powershell
.\execution\phase2-setup\New-EXOTransportRules.ps1 `
    -TargetDomainsFile domains.txt
```

### 10.2.1 Accepted Domain変更（WhatIfモード）
```powershell
.\execution\phase3-routing\Set-AcceptedDomainType.ps1 `
    -DomainsFile domains.txt `
    -DomainType InternalRelay `
    -WhatIfMode
```

### 10.2.2 Accepted Domain変更（本番実行）
```powershell
.\execution\phase3-routing\Set-AcceptedDomainType.ps1 `
    -DomainsFile domains.txt `
    -DomainType InternalRelay
```

### 10.3.1 DMZ SMTP transport変更（Docker環境）
```bash
# コンテナに入る
docker exec -it dmz-aws bash

# transport設定編集
vi /etc/postfix/transport

# 編集内容:
# test.example.co.jp      smtp:[postfix-hub]:25
# ↓ 以下に変更
# test.example.co.jp      smtp:[tenant.mail.protection.outlook.com]:25

# 設定反映
postmap /etc/postfix/transport
postfix reload
exit
```

---

## 11. 動作確認

### 11.1 テストメール送信
```powershell
.\lab-env\Send-TestEmail.ps1 -To "user@example.co.jp" -Subject "移行テスト"
```

### 11.2 Postfixログ確認
```bash
docker exec -it postfix-hub tail -50 /var/log/mail.log
docker exec -it dmz-aws tail -50 /var/log/mail.log
```

### 11.3 メールキュー確認
```bash
docker exec -it postfix-hub mailq
docker exec -it dmz-aws mailq
```

---

## 切り戻し

### transport復元（Docker環境）
```bash
docker exec -it dmz-aws bash -c "cp /etc/postfix/transport.bak /etc/postfix/transport && postmap /etc/postfix/transport && postfix reload"
```

### Accepted Domain復元
```powershell
.\execution\rollback\Restore-AcceptedDomainType.ps1 `
    -DomainsFile domains.txt
```

### コネクタ削除
```powershell
.\execution\rollback\Undo-EXOConnectors.ps1
```

---

## 参考: 接続コマンド

### Exchange Online接続
```powershell
Connect-ExchangeOnline -UserPrincipalName admin@contoso.onmicrosoft.com
```

### Microsoft Graph接続
```powershell
Connect-MgGraph -Scopes "User.ReadWrite.All","Group.ReadWrite.All","Directory.ReadWrite.All"
```

### EXO切断
```powershell
Disconnect-ExchangeOnline -Confirm:$false
```

### Graph切断
```powershell
Disconnect-MgGraph
```
