# Exchange Online移行 検証環境
# 顧客環境を再現: Courier IMAP + Postfix構成
#
# 構成:
# - courier-imap: メールボックスサーバー（Courier IMAP）
# - postfix-hub: 内部SMTPハブ（MUAからの送信受付）
# - dmz-aws: AWS DMZ SMTP（外部受口、EXO移行時のルーティング変更対象）
# - dmz-internal: 内部DMZ SMTP（EXOフォールバック用）
#
# 使用方法:
#   docker-compose up -d
#   docker-compose logs -f
#   docker-compose down

services:
  # ========================================
  # Courier IMAP（メールボックスサーバー）
  # 顧客環境のCourier IMAPを再現
  # ========================================
  courier-imap:
    build:
      context: ./courier-imap
      dockerfile: Dockerfile
    container_name: courier-imap
    hostname: courier-imap
    domainname: lab.local
    ports:
      - "143:143"     # IMAP
      - "993:993"     # IMAPS
    volumes:
      - courier-mail:/var/mail/vhosts
      - courier-userdb:/etc/courier
      - courier-logs:/var/log
    networks:
      - exo-lab-network
    restart: unless-stopped

  # ========================================
  # Postfix Hub（内部SMTPハブ）
  # MUAからの送信を受け付け、適切な宛先にルーティング
  # ========================================
  postfix-hub:
    build:
      context: ./postfix-hub
      dockerfile: Dockerfile
    container_name: postfix-hub
    hostname: postfix-hub
    domainname: lab.local
    ports:
      - "25:25"       # SMTP
      - "587:587"     # Submission
    volumes:
      - postfix-hub-spool:/var/spool/postfix
      - postfix-hub-logs:/var/log
    networks:
      - exo-lab-network
    depends_on:
      - courier-imap
      - dmz-aws
    restart: unless-stopped

  # ========================================
  # DMZ AWS SMTP（外部受口）
  # 外部からのメール受信、EXO移行時のルーティング変更対象
  # ========================================
  dmz-aws:
    build:
      context: ./dmz-postfix-aws
      dockerfile: Dockerfile
    container_name: dmz-aws
    hostname: dmz-aws
    domainname: lab.local
    ports:
      - "2525:25"     # 外部SMTP受付（ホスト側はポート変更）
    volumes:
      - dmz-aws-spool:/var/spool/postfix
      - dmz-aws-logs:/var/log
      # transportファイルをホストから編集可能に
      - ./dmz-postfix-aws/transport:/etc/postfix/transport:rw
    networks:
      - exo-lab-network
    depends_on:
      - postfix-hub
    restart: unless-stopped

  # ========================================
  # DMZ Internal SMTP（EXOフォールバック用）
  # EXOから未移行ユーザー宛のメールを受け取りCourier IMAPへ中継
  # ========================================
  dmz-internal:
    build:
      context: ./dmz-postfix-internal
      dockerfile: Dockerfile
    container_name: dmz-internal
    hostname: dmz-internal
    domainname: lab.local
    ports:
      - "2526:25"     # EXOからの接続用（ホスト側はポート変更）
    volumes:
      - dmz-internal-spool:/var/spool/postfix
      - dmz-internal-logs:/var/log
    networks:
      - exo-lab-network
    depends_on:
      - courier-imap
    restart: unless-stopped

# ========================================
# ボリューム定義
# ========================================
volumes:
  courier-mail:
    name: exo-lab-courier-mail
  courier-userdb:
    name: exo-lab-courier-userdb
  courier-logs:
    name: exo-lab-courier-logs
  postfix-hub-spool:
    name: exo-lab-postfix-hub-spool
  postfix-hub-logs:
    name: exo-lab-postfix-hub-logs
  dmz-aws-spool:
    name: exo-lab-dmz-aws-spool
  dmz-aws-logs:
    name: exo-lab-dmz-aws-logs
  dmz-internal-spool:
    name: exo-lab-dmz-internal-spool
  dmz-internal-logs:
    name: exo-lab-dmz-internal-logs

# ========================================
# ネットワーク定義
# ========================================
networks:
  exo-lab-network:
    name: exo-lab-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
