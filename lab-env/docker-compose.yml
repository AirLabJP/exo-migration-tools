# Exchange Online移行 検証環境（Courier IMAP + Postfix構成）
# Windows Server上のDocker Desktopで動作
# ※顧客環境のCourier IMAPを正確に再現

services:
  # === Courier IMAP（メールボックスサーバー） ===
  # 顧客環境のCourier IMAPを再現（Dovecotではない）
  courier-imap:
    build:
      context: ./docker/courier-imap
      dockerfile: Dockerfile
    container_name: lab-courier-imap
    hostname: courier-imap
    domainname: lab.local
    ports:
      - "143:143"    # IMAP
      - "993:993"    # IMAPS
    volumes:
      - courier-mail:/var/mail/vhosts
      - courier-config:/etc/courier
      - ./docker/courier-imap/scripts:/scripts:ro
    networks:
      - lab-network
    restart: unless-stopped

  # === Postfix Hub（内部SMTPハブ） ===
  # Thunderbird等からの送信受付、内部配送
  postfix-hub:
    build:
      context: ./docker/postfix-hub
      dockerfile: Dockerfile
    container_name: lab-postfix-hub
    hostname: postfix-hub
    domainname: lab.local
    ports:
      - "25:25"      # SMTP
      - "587:587"    # Submission
    volumes:
      - postfix-hub-spool:/var/spool/postfix
      - ./docker/postfix-hub/scripts:/scripts:ro
    depends_on:
      - courier-imap
    networks:
      - lab-network
    restart: unless-stopped

  # === DMZ AWS（外部受口・EXOルーティング変更対象） ===
  # FireEyeからのメール受信、EXO移行後のルーティング変更対象
  dmz-aws:
    build:
      context: ./docker/dmz-postfix-aws
      dockerfile: Dockerfile
    container_name: lab-dmz-aws
    hostname: dmz-aws
    domainname: lab.local
    ports:
      - "2525:25"    # 外部SMTP（ホストポート変更）
    volumes:
      - dmz-aws-spool:/var/spool/postfix
      - ./docker/dmz-postfix-aws/scripts:/scripts:ro
      - ./docker/dmz-postfix-aws/transport.exo:/etc/postfix/transport.exo:ro
      - ./docker/dmz-postfix-aws/transport.bak:/etc/postfix/transport.bak:ro
    depends_on:
      - postfix-hub
    networks:
      - lab-network
    restart: unless-stopped

  # === DMZ Internal（EXOフォールバック用） ===
  # EXOからInternal Relay経由で未移行ユーザーへ配送
  dmz-internal:
    build:
      context: ./docker/dmz-postfix-internal
      dockerfile: Dockerfile
    container_name: lab-dmz-internal
    hostname: dmz-internal
    domainname: lab.local
    ports:
      - "2526:25"    # 内部DMZ SMTP
    volumes:
      - dmz-internal-spool:/var/spool/postfix
      - ./docker/dmz-postfix-internal/scripts:/scripts:ro
    depends_on:
      - courier-imap
    networks:
      - lab-network
    restart: unless-stopped

volumes:
  courier-mail:
  courier-config:
  postfix-hub-spool:
  dmz-aws-spool:
  dmz-internal-spool:

networks:
  lab-network:
    name: exo-lab-network
    driver: bridge
