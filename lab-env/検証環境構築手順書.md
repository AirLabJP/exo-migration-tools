# Exchange Online移行 検証環境構築手順書

## 概要

本書は、Exchange Online移行プロジェクトの検証環境を構築するための手順を記載する。

### 検証環境の目的

1. **暗黙知の可視化**: 実際に環境を構築・運用し、現行環境の暗黙知を洗い出す
2. **スクリプト・手順の妥当性検証**: 本番投入前にスクリプトと手順書の動作を確認
3. **課題の早期発見**: 移行作業における潜在的な問題を事前に特定

---

## 1. 環境構成

### 1.1 物理構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│  検証用 Windows クライアント端末（物理: 1台）                             │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ GUI アプリケーション                                              │   │
│  │ - Thunderbird（社内所定配置先より取得）                           │   │
│  │ - Outlook（社内所定配置先より取得）                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Hyper-V（Windows Server 2022 × 3台）                             │   │
│  │                                                                   │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │ VM1: DC01    │  │ VM2: DC02    │  │ VM3: AADC01  │           │   │
│  │  │ AD DS        │  │ AD DS        │  │ Entra Connect│           │   │
│  │  │ (PDC)        │  │ (Replica)    │  │              │           │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Docker Desktop                                                    │   │
│  │                                                                   │   │
│  │  ┌───────────────────────────────────────────────────────┐       │   │
│  │  │ Linux メール環境（現行環境再現）                        │       │   │
│  │  │                                                        │       │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │       │   │
│  │  │  │ courier-imap│  │ postfix-hub │  │ dmz-aws     │   │       │   │
│  │  │  │ (IMAP)      │  │ (内部SMTP)  │  │ (外部受口)  │   │       │   │
│  │  │  │ Port:143,993│  │ Port:25     │  │ Port:2525   │   │       │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘   │       │   │
│  │  │                                                        │       │   │
│  │  │  ┌─────────────┐                                      │       │   │
│  │  │  │ dmz-internal│ ← EXO フォールバック用               │       │   │
│  │  │  │ (内部DMZ)   │                                      │       │   │
│  │  │  │ Port:2526   │                                      │       │   │
│  │  │  └─────────────┘                                      │       │   │
│  │  └───────────────────────────────────────────────────────┘       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 クラウド環境

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Microsoft クラウド（試験版テナント）                                    │
│                                                                         │
│  ┌──────────────────┐  ┌──────────────────┐                            │
│  │ Entra ID         │  │ Exchange Online  │                            │
│  │ (Azure AD)       │  │                  │                            │
│  │                  │◀─│                  │                            │
│  │ - ユーザー同期   │  │ - メールボックス │                            │
│  │ - グループ同期   │  │ - コネクタ       │                            │
│  │ - ライセンス管理 │  │ - Transport Rule │                            │
│  └──────────────────┘  └──────────────────┘                            │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 メールフロー（検証環境）

```
【送信フロー】
Thunderbird → postfix-hub → courier-imap (内部配送)
                         → dmz-aws → インターネット (外部送信)

【受信フロー】
インターネット → dmz-aws → postfix-hub → courier-imap

【EXO移行後】
Outlook → Exchange Online → dmz-internal → courier-imap (未移行ユーザー宛)
                         → インターネット (外部宛)

外部 → dmz-aws → Exchange Online (移行済みユーザー宛)
              → postfix-hub → courier-imap (未移行ユーザー宛)
```

---

## 2. 事前準備

### 2.1 物理端末の要件

| 項目 | 要件 |
|---|---|
| OS | Windows 10/11 Pro 以上（Hyper-V対応） |
| CPU | 8コア以上推奨 |
| メモリ | 32GB以上推奨（VM×3 + Docker） |
| ストレージ | 500GB以上（SSD推奨） |
| ネットワーク | インターネット接続（Microsoft 365接続用） |

### 2.2 ソフトウェア取得

社内コンプライアンスに従い、以下のソフトウェアを所定の配置先から取得する。

| ソフトウェア | バージョン | 取得先 |
|---|---|---|
| Thunderbird | 最新安定版 | （社内所定配置先） |
| Microsoft Outlook | Microsoft 365版 | （社内所定配置先） |
| Docker Desktop | 最新安定版 | （社内所定配置先） |
| Windows Server 2022 ISO | 評価版可 | （社内所定配置先） |

### 2.3 Microsoft 365 試験テナント

| 項目 | 内容 |
|---|---|
| テナント種別 | 開発者テナント または E5試用版 |
| 必要ライセンス | Microsoft 365 E3/E5（Exchange Online含む） |
| ドメイン | カスタムドメイン追加（test.example.co.jp等） |

---

## 3. Hyper-V環境構築

### 3.1 Hyper-V有効化

```powershell
# 管理者PowerShellで実行
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All
# 再起動が必要
```

### 3.2 仮想スイッチ作成

```powershell
# 内部ネットワーク用スイッチ
New-VMSwitch -Name "EXO-Lab-Internal" -SwitchType Internal

# 外部接続用スイッチ（既存のネットワークアダプタを使用）
New-VMSwitch -Name "EXO-Lab-External" -NetAdapterName "イーサネット" -AllowManagementOS $true
```

### 3.3 VM作成

#### VM1: DC01（プライマリドメインコントローラー）

```powershell
$VMName = "DC01"
$VMPath = "D:\Hyper-V\$VMName"

# VM作成
New-VM -Name $VMName -MemoryStartupBytes 4GB -Generation 2 -Path $VMPath
Set-VMMemory -VMName $VMName -DynamicMemoryEnabled $true -MinimumBytes 2GB -MaximumBytes 8GB
Set-VMProcessor -VMName $VMName -Count 2

# VHD作成
New-VHD -Path "$VMPath\$VMName.vhdx" -SizeBytes 100GB -Dynamic
Add-VMHardDiskDrive -VMName $VMName -Path "$VMPath\$VMName.vhdx"

# ネットワーク
Connect-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-Internal"
Add-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-External"

# ISOマウント
Set-VMDvdDrive -VMName $VMName -Path "D:\ISO\WindowsServer2022.iso"
```

#### VM2: DC02（レプリカドメインコントローラー）

```powershell
$VMName = "DC02"
$VMPath = "D:\Hyper-V\$VMName"

New-VM -Name $VMName -MemoryStartupBytes 4GB -Generation 2 -Path $VMPath
Set-VMMemory -VMName $VMName -DynamicMemoryEnabled $true -MinimumBytes 2GB -MaximumBytes 8GB
Set-VMProcessor -VMName $VMName -Count 2
New-VHD -Path "$VMPath\$VMName.vhdx" -SizeBytes 100GB -Dynamic
Add-VMHardDiskDrive -VMName $VMName -Path "$VMPath\$VMName.vhdx"
Connect-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-Internal"
Add-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-External"
Set-VMDvdDrive -VMName $VMName -Path "D:\ISO\WindowsServer2022.iso"
```

#### VM3: AADC01（Entra ID Connect）

```powershell
$VMName = "AADC01"
$VMPath = "D:\Hyper-V\$VMName"

New-VM -Name $VMName -MemoryStartupBytes 4GB -Generation 2 -Path $VMPath
Set-VMMemory -VMName $VMName -DynamicMemoryEnabled $true -MinimumBytes 2GB -MaximumBytes 8GB
Set-VMProcessor -VMName $VMName -Count 2
New-VHD -Path "$VMPath\$VMName.vhdx" -SizeBytes 100GB -Dynamic
Add-VMHardDiskDrive -VMName $VMName -Path "$VMPath\$VMName.vhdx"
Connect-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-Internal"
Add-VMNetworkAdapter -VMName $VMName -SwitchName "EXO-Lab-External"
Set-VMDvdDrive -VMName $VMName -Path "D:\ISO\WindowsServer2022.iso"
```

### 3.4 Windows Server インストール・初期設定

各VMで以下を実施:

1. Windows Server 2022 インストール（Desktop Experience）
2. コンピュータ名設定（DC01, DC02, AADC01）
3. IPアドレス設定（静的IP推奨）
4. Windows Update適用

**IP設定例**:

| VM | IP | DNS |
|---|---|---|
| DC01 | 192.168.100.10 | 127.0.0.1, 192.168.100.11 |
| DC02 | 192.168.100.11 | 192.168.100.10, 127.0.0.1 |
| AADC01 | 192.168.100.20 | 192.168.100.10, 192.168.100.11 |

### 3.5 Active Directory構築

#### DC01: フォレスト・ドメイン作成

```powershell
# AD DS役割インストール
Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools

# フォレスト・ドメイン作成
$DomainName = "lab.local"
$NetBIOSName = "LAB"
$SafeModePassword = ConvertTo-SecureString "P@ssw0rd123!" -AsPlainText -Force

Install-ADDSForest `
    -DomainName $DomainName `
    -DomainNetBIOSName $NetBIOSName `
    -SafeModeAdministratorPassword $SafeModePassword `
    -InstallDns:$true `
    -Force:$true
# 自動再起動
```

#### DC02: レプリカDC追加

```powershell
# AD DS役割インストール
Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools

# ドメイン参加
$DomainName = "lab.local"
$Credential = Get-Credential  # LAB\Administrator
Add-Computer -DomainName $DomainName -Credential $Credential -Restart

# 再起動後、レプリカDCに昇格
$SafeModePassword = ConvertTo-SecureString "P@ssw0rd123!" -AsPlainText -Force
$Credential = Get-Credential  # LAB\Administrator

Install-ADDSDomainController `
    -DomainName $DomainName `
    -Credential $Credential `
    -SafeModeAdministratorPassword $SafeModePassword `
    -InstallDns:$true `
    -Force:$true
```

### 3.6 ADスキーマ拡張

Exchange属性を使用するため、ADスキーマを拡張する。

```powershell
# DC01（スキーママスター）で実行

# Exchange Server 2019 CUのISOをマウント
# D:\にマウントされた場合

# スキーマ拡張
D:\Setup.exe /PrepareSchema /IAcceptExchangeServerLicenseTerms_DiagnosticDataON

# AD準備
D:\Setup.exe /PrepareAD /OrganizationName:"LabOrg" /IAcceptExchangeServerLicenseTerms_DiagnosticDataON

# ドメイン準備
D:\Setup.exe /PrepareDomain /IAcceptExchangeServerLicenseTerms_DiagnosticDataON
```

### 3.7 Entra ID Connect インストール

#### AADC01: ドメイン参加

```powershell
$DomainName = "lab.local"
$Credential = Get-Credential  # LAB\Administrator
Add-Computer -DomainName $DomainName -Credential $Credential -Restart
```

#### Entra ID Connect インストール

1. Microsoft Entra管理センターからEntra ID Connectをダウンロード
2. AADC01でインストーラを実行
3. カスタムインストールを選択
4. 以下を設定:
   - ソースアンカー: objectGUID
   - 同期対象OU: テスト用OU
   - パスワードハッシュ同期: 有効
   - シングルサインオン: 任意

---

## 4. Docker環境構築

### 4.1 Docker Desktop インストール

1. 社内所定配置先からDocker Desktop インストーラを取得
2. インストール実行
3. WSL 2バックエンドを有効化（推奨）
4. 再起動

### 4.2 Dockerネットワーク設定

```powershell
# Docker Desktopが起動していることを確認
docker network create exo-lab-network
```

### 4.3 Docker Compose起動

```bash
cd lab-env/docker
docker-compose up -d
```

### 4.4 テストユーザー作成

```bash
# コンテナ内でユーザー作成
docker exec -it courier-imap /scripts/create_users.sh
```

---

## 5. メールクライアント設定

### 5.1 Thunderbird設定

| 項目 | 設定値 |
|---|---|
| メールアドレス | user1@test.example.co.jp |
| 受信サーバー (IMAP) | localhost:143 |
| 送信サーバー (SMTP) | localhost:25 |
| 認証 | 通常のパスワード |
| 接続の保護 | なし（検証環境） |

### 5.2 Outlook設定（EXO移行後）

| 項目 | 設定値 |
|---|---|
| メールアドレス | user1@test.example.co.jp |
| アカウントタイプ | Microsoft 365 |
| 認証 | Entra ID（SSO） |

---

## 6. 検証シナリオ

### 6.1 Phase 1: 現行環境再現

- [ ] Dockerコンテナ全起動確認
- [ ] Thunderbirdからのメール送受信確認
- [ ] 内部配送（Courier IMAP）確認
- [ ] 外部送信経路確認

### 6.2 Phase 2: Microsoft環境構築

- [ ] ADスキーマ拡張完了
- [ ] Entra ID Connect同期確認
- [ ] テストユーザーのEntra ID反映確認
- [ ] Exchange Onlineテナント確認

### 6.3 Phase 3: AD属性投入・メールボックス作成

- [ ] Set-ADMailAddressesFromCsv.ps1 実行
- [ ] proxyAddresses属性確認
- [ ] ライセンスグループ追加
- [ ] メールボックス作成確認

### 6.4 Phase 4: EXOコネクタ・ルール設定

- [ ] New-EXOConnectors.ps1 実行
- [ ] New-EXOTransportRules.ps1 実行
- [ ] Accepted Domain設定（InternalRelay）

### 6.5 Phase 5: ルーティング切替

- [ ] dmz-awsのtransport設定変更
- [ ] メールフロー検証（全パターン）

### 6.6 Phase 6: 切り戻し検証

- [ ] transport設定復元
- [ ] Accepted Domain復元
- [ ] メールフロー正常性確認

---

## 7. トラブルシューティング

### 7.1 Hyper-V関連

| 症状 | 対処 |
|---|---|
| VMが起動しない | Hyper-V機能の有効化を確認、BIOS仮想化設定を確認 |
| ネットワーク接続不可 | 仮想スイッチの設定を確認、Windowsファイアウォール確認 |
| メモリ不足 | 動的メモリの最小値を下げる、不要なVMを停止 |

### 7.2 Docker関連

| 症状 | 対処 |
|---|---|
| コンテナ起動失敗 | `docker logs <container>` でログ確認 |
| ポート競合 | `netstat -an | findstr :25` でポート使用状況確認 |
| Courier認証失敗 | `/etc/courier/userdb` の権限確認 |

### 7.3 AD関連

| 症状 | 対処 |
|---|---|
| レプリケーション失敗 | `repadmin /replsummary` で状況確認 |
| スキーマ拡張失敗 | スキーママスターで実行しているか確認 |
| Entra Connect同期失敗 | Synchronization Service Managerでエラー確認 |

---

## 8. 参考資料

- [Courier IMAP公式ドキュメント](https://www.courier-mta.org/imap/)
- [Postfix公式ドキュメント](http://www.postfix.org/documentation.html)
- [Microsoft Entra Connect](https://learn.microsoft.com/ja-jp/entra/identity/hybrid/connect/)
- [Exchange Online PowerShell](https://learn.microsoft.com/ja-jp/powershell/exchange/exchange-online-powershell)

---

## 改訂履歴

| 版 | 日付 | 変更内容 | 作成者 |
|---|---|---|---|
| 1.0 | 2026-01-20 | 初版作成 | |
